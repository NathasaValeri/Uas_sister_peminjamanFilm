<script>
    // --- 1. CONFIGURATION ---
    // Pastikan URL ini sesuai dengan domain utama di Clever Cloud (tanpa slash di akhir)
    const CLOUD_URL = 'https://app-5a385a3b-97b5-43cb-9404-4cb808ff975b.cleverapps.io'; 
    
    // Logika deteksi otomatis: Jika buka di laptop pakai localhost, jika di internet pakai Cloud
    const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

    // PERBAIKAN: Jika backend digabung (Monolith/Gateway), biasanya semua pakai CLOUD_URL yang sama
    const API = {
        auth:   isLocal ? 'http://localhost:3000/auth'   : `${CLOUD_URL}/auth`,
        movie:  isLocal ? 'http://localhost:3000/movies' : `${CLOUD_URL}/movies`,
        rental: isLocal ? 'http://localhost:3000/rentals' : `${CLOUD_URL}/rentals`
    };

    let isLoginMode = true;

    function toggleAuth() {
        isLoginMode = !isLoginMode;
        document.getElementById('authTitle').innerText = isLoginMode ? "Login Admin" : "Daftar Akun Baru";
        document.getElementById('username').classList.toggle('hidden', isLoginMode);
        document.getElementById('toggleBtn').innerText = isLoginMode ? "Belum punya akun? Daftar" : "Sudah punya akun? Login";
    }

    async function handleAuth() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const username = document.getElementById('username').value;
        const target = isLoginMode ? 'login' : 'register';

        if(!email || !password) return alert("Lengkapi data!");
        const payload = { email, password };
        if (!isLoginMode) payload.username = username;

        try {
            // URL yang dipanggil: https://...cleverapps.io/auth/login
            const res = await fetch(`${API.auth}/${target}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            if(res.ok) {
                if(isLoginMode) {
                    alert("Login Berhasil!");
                    document.getElementById('authSection').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    refreshData();
                } else {
                    alert("Pendaftaran Berhasil! Silakan Login."); 
                    toggleAuth();
                }
            } else { 
                alert("Gagal: " + (data.message || "Email/Password salah")); 
            }
        } catch (err) { 
            console.error(err);
            alert("Koneksi Error! Pastikan Backend di Clever Cloud sudah 'Hijau' dan URL benar."); 
        }
    }

    async function refreshData() {
        try {
            // Mengambil data film
            const mRes = await fetch(`${API.movie}/all`);
            if(!mRes.ok) throw new Error("Gagal ambil katalog");
            const movies = await mRes.json();
            
            document.getElementById('movieList').innerHTML = movies.map(m => `
                <div class="p-3 bg-gray-50 border rounded flex justify-between items-center text-xs shadow-sm">
                    <span><b class="text-blue-700 text-sm">${m.title}</b> (ID: ${m.id})<br>Genre: ${m.genre} | Stok: ${m.stock}</span>
                    <div class="flex gap-2">
                        <button onclick="editMovie(${m.id}, '${m.title}', '${m.genre}', ${m.stock})" class="text-blue-500 font-bold hover:underline">Edit</button>
                        <button onclick="deleteMovie(${m.id})" class="text-red-500 font-bold hover:underline">Hapus</button>
                    </div>
                </div>
            `).join('');

            // Mengambil data riwayat rental
            const rRes = await fetch(`${API.rental}/all`);
            if(!rRes.ok) throw new Error("Gagal ambil riwayat");
            const rentals = await rRes.json();
            
            document.getElementById('rentalList').innerHTML = rentals.map(r => {
                const tgl = r.createdAt ? new Date(r.createdAt).toLocaleString('id-ID') : 'Baru saja';
                return `
                    <div class="p-3 bg-purple-50 border border-purple-100 rounded shadow-sm text-xs">
                        <div class="flex justify-between items-start">
                            <span>
                                <b class="text-purple-700 text-sm">${r.customer_name}</b><br>
                                <span class="font-semibold text-gray-600">Film ID: ${r.movie_id}</span><br>
                                <span class="text-gray-500">ðŸ“… ${tgl}</span>
                            </span>
                            <div class="flex flex-col gap-1">
                                <button onclick="finishRental(${r.id})" class="bg-green-500 text-white px-2 py-1 rounded font-bold text-[10px]">Selesai</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (e) { 
            console.error("Fetch Error:", e); 
        }
    }

    // Fungsi lainnya (addMovie, deleteMovie, addRental, dll) tetap sama seperti kode Anda sebelumnya
    // Pastikan saja URL yang dipanggil menggunakan API.movie atau API.rental
</script>
